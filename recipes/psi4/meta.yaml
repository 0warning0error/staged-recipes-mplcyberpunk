{% set name = "psi4" %}
{% set version "1.7.100" %}
{% set sha256 = "705f5467a165fbbe2ed3e9e1c554a8c786a677d271ded74f31f94948f1f906f0" %}

package:
  name: {{ name|lower }}
  #version: {{ data.get('version') }}
  version: {{ version }}

source:
  # url: https://github.com/{{ name }}/{{ name }}/archive/v{{ version }}.tar.gz
  url: https://github.com/loriab/psi4/archive/intel17l2.tar.gz
  sha256: {{ sha256 }}

build:
  number: 0
  binary_relocation: true
  skip: true                                 # [win]
  skip: true                                 # [py != 39]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake
    - ninja
    - llvm-openmp                            # [osx]
    - libgomp                                # [linux]
  host:
    - eigen
    - boost-cpp
    - mkl-devel
    - pybind11
    - pybind11-abi
    - python
    # qc req'd
    - gau2grid
    - conda-forge/label/libint_dev::libint {{ libint }}
    - libxc-c
    - optking
    - qcelemental
    - qcengine
  run:
    - libblas * *mkl
    - msgpack-python
    - networkx
    - numpy
    - python
    - scipy
    # qc
    - {{ pin_compatible('libint', upper_bound='{{ libint }}') }}
    - {{ pin_compatible('optking', upper_bound='0.5') }}
    - {{ pin_compatible('qcelemental', upper_bound='0.26') }}
    - {{ pin_compatible('qcengine', upper_bound='0.27') }}
      # someday, qcengine and qcelemental should be `max_pin='x'` again

test:
  imports:
    - psi4
  requires:
    - pytest >= 7.0.1
    - pytest-xdist
  commands:
    - ls -l $PREFIX/lib                                   # [unix]
    - ls -l $PREFIX/share/cmake/libefp                    # [unix]
    - ls -l $SP_DIR/psi4                                  # [unix]
    - dir %PREFIX%\\Library                               # [win]
    - dir %PREFIX%\\Library\\include                      # [win]
    - dir %SP_DIR%\\psi4                                  # [win]
    # Verify existence and execution
    - test -f $SP_DIR/psi4/core*.so                       # [unix]
    - test -f $PREFIX/bin/psi4                            # [unix]
    - $PREFIX/bin/psi4 --version                          # [unix]
    - if not exist %SP_DIR%\\psi4\\core*.pyd exit 1       # [win]
    - if not exist %PREFIX%\\bin\\psi4.bat exit 1         # [win]
    - %PREFIX%\\bin\\psi4 --version                       # [win]
    # Verify accessories
    - test -f $PREFIX/include/psi4/psi4-dec.h             # [unix]
    - test -f $PREFIX/share/cmake/psi4/psi4Config.cmake   # [unix]
    - test -f $PREFIX/share/cmake/TargetLAPACK/TargetLAPACKConfig.cmake  # [unix]
    - test -f $PREFIX/share/psi4/basis/cc-pvdz.gbs        # [unix]
    - if not exist %PREFIX%\\Library\\include\\psi4\\psi4-dec.h exit 1  # [win]
    - if not exist %PREFIX%\\Library\\share\\cmake\\psi4\\psi4Config.cmake exit 1  # [win]
    - if not exist %PREFIX%\\Library\\share\\cmake\\TargetLAPACK\\TargetLAPACKConfig.cmake exit 1  # [win]
    - if not exist %PREFIX%\\Library\\share\\psi4\\basis\\cc-pvdz.gbs exit 1  # [win]
    # Inspect linkage
    - ldd -v $SP_DIR/psi4/core*.so                        # [linux]
    - otool -L $SP_DIR/psi4/core*.so                      # [osx]
    # Actually test
    - MKL_CBWR=AVX pytest -rws -v --durations=20 --color yes -n auto $SP_DIR/psi4 -m "quick"  # [unix]
    - pytest -rws -v --durations=20 --color yes -n auto %SP_DIR%\\psi4 -m "quick"  # [win]

about:
  home: http://psicode.org
  dev_url: https://github.com/psi4/psi4
  doc_url: http://psicode.org/psi4manual/master/index.html
  doc_source_url: https://github.com/psi4/psi4/tree/master/doc/sphinxman/source
  license: LGPL-3.0-only
  license_url: https://opensource.org/license/lgpl-3-0/
  license_file:
    - COPYING
    - COPYING.LESSER
  license_family: LGPL
  summary: "Open-Source Quantum Chemistry - an electronic structure package in C++ driven by Python"
  description: |
    Psi4 is an open-source suite of ab initio quantum chemistry programs designed for efficient,
    high-accuracy simulations of a variety of molecular properties. We can routinely perform computations
    with more than 2500 basis functions running serially or on multi-core machines. With computationally
    demanding portions written in C++, Pybind11 exports many of the C++ classes into Python, and a
    flexible Python driver, Psi4 strives to be friendly to both users and developers.

extra:
  recipe-maintainers:
    - loriab
